<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>设置</title>
    <style>
      html, body { height: 100%; margin: 0; }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        padding: 16px;
        box-sizing: border-box;
      }
      header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
      h1 { font-size: 16px; margin: 0; }
      button { padding: 6px 10px; font-size: 13px; }
      .tabs { display: flex; gap: 8px; margin-top: 12px; }
      .divider { height: 1px; background: rgba(0,0,0,0.18); margin-top: 10px; }
      .tab {
        padding: 6px 10px;
        font-size: 13px;
        border: 1px solid rgba(0,0,0,0.15);
        background: transparent;
      }
      .tab[aria-selected="true"] {
        background: rgba(0,0,0,0.06);
      }
      .panel { margin-top: 14px; display: none; }
      .panel.__open { display: block; }
      .toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
      .label { font-size: 13px; opacity: 0.8; margin: 0 0 8px; }

      table { width: 100%; border-collapse: collapse; }
      th, td { text-align: left; padding: 8px 10px; font-size: 13px; }
      thead th { font-size: 12px; opacity: 0.8; border-bottom: 1px solid rgba(0,0,0,0.18); }
      tbody td { border-bottom: 1px solid rgba(0,0,0,0.10); }
      tbody tr:last-child td { border-bottom: 0; }
      td.value { text-align: right; white-space: nowrap; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

      /* Indent offline breakdown rows under "离线缓存合计". */
      tr.offline-sub td:first-child { padding-left: 26px; }

      /* Indent cache detail rows under "磁盘缓存总计". */
      tr.disk-sub td:first-child { padding-left: 26px; }
    </style>
  </head>
  <body>
    <header>
      <h1>设置</h1>
      <div></div>
    </header>

    <div class="tabs" role="tablist" aria-label="设置">
      <button class="tab" id="tab-cache" type="button" role="tab" aria-selected="true" aria-controls="panel-cache">缓存</button>
      <button class="tab" id="tab-system" type="button" role="tab" aria-selected="false" aria-controls="panel-system">系统</button>
      <button class="tab" id="tab-about" type="button" role="tab" aria-selected="false" aria-controls="panel-about">关于</button>
    </div>

    <div class="divider" role="separator" aria-hidden="true"></div>

    <section class="panel __open" id="panel-cache" role="tabpanel" aria-labelledby="tab-cache">
      <div class="toolbar">
        <button id="refreshCache" type="button">刷新缓存大小</button>
        <button id="clearOfflineCache" type="button">清理离线缓存</button>
        <button id="openCacheFolder" type="button">打开缓存文件夹</button>
      </div>

      <div class="label">缓存占用</div>
      <table aria-label="缓存占用">
        <thead>
          <tr>
            <th>项目</th>
            <th class="value">大小</th>
          </tr>
        </thead>
        <tbody id="cacheTable">
          <tr><td>HTTP 缓存</td><td class="value" id="cell-http">-</td></tr>
          <tr><td>离线缓存合计</td><td class="value" id="cell-offline-total">-</td></tr>
          <tr class="offline-sub"><td>CacheStorage（含 OSS 永久缓存）</td><td class="value" id="cell-offline-cache">-</td></tr>
          <tr class="offline-sub"><td>Service Worker</td><td class="value" id="cell-offline-sw">-</td></tr>
          <tr class="offline-sub"><td>本地消息缓存（SQLite）</td><td class="value" id="cell-offline-sqlite">-</td></tr>
          <tr><td>磁盘缓存总计</td><td class="value" id="cell-disk-total">-</td></tr>
        </tbody>
      </table>
    </section>

    <section class="panel" id="panel-system" role="tabpanel" aria-labelledby="tab-system">
      <div class="label">系统信息</div>
      <table aria-label="系统信息">
        <thead>
          <tr>
            <th>项目</th>
            <th class="value">值</th>
          </tr>
        </thead>
        <tbody id="systemTable">
          <tr><td>系统时钟</td><td class="value mono" id="sys-clock">-</td></tr>
        </tbody>
      </table>
    </section>

    <section class="panel" id="panel-about" role="tabpanel" aria-labelledby="tab-about">
      <div class="label">关于</div>
      <table aria-label="关于">
        <thead>
          <tr>
            <th>项目</th>
            <th class="value">值</th>
          </tr>
        </thead>
        <tbody id="aboutTable">
          <tr><td>版本号</td><td class="value mono" id="about-version">-</td></tr>
          <tr><td>编译时间</td><td class="value mono" id="about-build-time">-</td></tr>
        </tbody>
      </table>
    </section>

    <script>
      const $ = (id) => document.getElementById(id);

      function formatBytes(bytes) {
        if (typeof bytes !== 'number' || !Number.isFinite(bytes) || bytes < 0) return '-';
        const units = ['B', 'KB', 'MB', 'GB', 'TB'];
        let value = bytes;
        let unitIndex = 0;
        while (value >= 1024 && unitIndex < units.length - 1) {
          value /= 1024;
          unitIndex++;
        }
        const digits = unitIndex === 0 ? 0 : unitIndex === 1 ? 1 : 2;
        return `${value.toFixed(digits)} ${units[unitIndex]}`;
      }

      async function refresh() {
        try {
          $('refreshCache').disabled = true;
          $('clearOfflineCache').disabled = true;
          const api = window.agathaSettings;
          if (!api || typeof api.getCacheInfo !== 'function') {
            $('cell-http').textContent = '不可用';
            return;
          }

          // Offline cache (CacheStorage / Service Worker)
          try {
            if (typeof api.getOfflineCacheInfo === 'function') {
              const offline = await api.getOfflineCacheInfo();
              $('cell-offline-cache').textContent = formatBytes(offline?.cacheStorageBytes);
              $('cell-offline-sw').textContent = formatBytes(offline?.serviceWorkerBytes);
              $('cell-offline-sqlite').textContent = formatBytes(offline?.sqliteBytes);
              $('cell-offline-total').textContent = formatBytes(offline?.offlineTotalBytes);
            } else {
              $('cell-offline-cache').textContent = '-';
              $('cell-offline-sw').textContent = '-';
              $('cell-offline-sqlite').textContent = '-';
              $('cell-offline-total').textContent = '-';
            }
          } catch (e) {
            $('cell-offline-cache').textContent = '读取失败';
            $('cell-offline-sw').textContent = '读取失败';
            $('cell-offline-sqlite').textContent = '读取失败';
            $('cell-offline-total').textContent = '读取失败';
          }

          const info = await api.getCacheInfo();
          $('cell-http').textContent = formatBytes(info.httpCacheBytes);
          $('cell-disk-total').textContent = info.diskCacheTotalBytes != null ? formatBytes(info.diskCacheTotalBytes) : '-';

          const tbody = $('cacheTable');
          // Remove previously appended disk breakdown rows only.
          Array.from(tbody.querySelectorAll('tr.disk-sub')).forEach((tr) => {
            try { tr.remove(); } catch (e) {}
          });
          if (Array.isArray(info.diskCacheFolders)) {
            for (const entry of info.diskCacheFolders) {
              // These are already shown in the offline section above.
              if (entry && (entry.name === 'CacheStorage' || entry.name === 'Service Worker' || entry.name === 'Minechat SQLite')) {
                continue;
              }
              const tr = document.createElement('tr');
              tr.className = 'disk-sub';
              const tdName = document.createElement('td');
              tdName.textContent = entry.name;
              const tdVal = document.createElement('td');
              tdVal.className = 'value';
              tdVal.textContent = formatBytes(entry.bytes);
              tr.appendChild(tdName);
              tr.appendChild(tdVal);
              tbody.appendChild(tr);
            }
          }
        } catch (e) {
          $('cell-http').textContent = '读取失败';
        } finally {
          $('refreshCache').disabled = false;
          $('clearOfflineCache').disabled = false;
        }
      }

      async function clearOfflineCache() {
        const api = window.agathaSettings;
        if (!api || typeof api.clearOfflineCache !== 'function') return;
        try {
          $('clearOfflineCache').disabled = true;
          $('refreshCache').disabled = true;
          await api.clearOfflineCache();
        } finally {
          $('clearOfflineCache').disabled = false;
          $('refreshCache').disabled = false;
          // refresh UI after clear
          refresh();
        }
      }

      async function openCacheFolder() {
        const api = window.agathaSettings;
        if (!api || typeof api.openCacheFolder !== 'function') return;
        try {
          $('openCacheFolder').disabled = true;
          await api.openCacheFolder();
        } finally {
          $('openCacheFolder').disabled = false;
        }
      }

      function setTab(active) {
        const isCache = active === 'cache';
        const isSystem = active === 'system';
        const isAbout = active === 'about';

        $('tab-cache').setAttribute('aria-selected', String(isCache));
        $('tab-system').setAttribute('aria-selected', String(isSystem));
        $('tab-about').setAttribute('aria-selected', String(isAbout));

        $('panel-cache').classList.toggle('__open', isCache);
        $('panel-system').classList.toggle('__open', isSystem);
        $('panel-about').classList.toggle('__open', isAbout);
      }

      function upsertSystemRow(label, value) {
        const tbody = $('systemTable');
        const id = `sys-${label.replace(/[^a-z0-9]+/gi, '-').toLowerCase()}`;
        let row = $(id);
        if (!row) {
          row = document.createElement('tr');
          row.id = id;
          const td1 = document.createElement('td');
          td1.textContent = label;
          const td2 = document.createElement('td');
          td2.className = 'value mono';
          td2.textContent = value ?? '-';
          row.appendChild(td1);
          row.appendChild(td2);
          tbody.appendChild(row);
        } else {
          row.children[1].textContent = value ?? '-';
        }
      }

      async function refreshSystem() {
        const api = window.agathaSettings;
        if (!api || typeof api.getSystemInfo !== 'function') return;
        const info = await api.getSystemInfo();
        if (!info) return;

        upsertSystemRow('平台', info.platform);
        upsertSystemRow('架构', info.arch);
        upsertSystemRow('系统版本', info.osRelease);
        upsertSystemRow('CPU', info.cpu);
        upsertSystemRow('CPU 核心数', info.cpuCount != null ? String(info.cpuCount) : null);
        upsertSystemRow('内存总量', info.totalMem);
        upsertSystemRow('空闲内存', info.freeMem);
        upsertSystemRow('应用版本', info.appVersion);
        upsertSystemRow('Electron', info.versions?.electron);
        upsertSystemRow('Chrome', info.versions?.chrome);
        upsertSystemRow('Node', info.versions?.node);
        upsertSystemRow('时区', info.timeZone);
      }

      function formatDateTime(value) {
        try {
          const d = value instanceof Date ? value : new Date(value);
          if (Number.isNaN(d.getTime())) return '-';
          return d.toLocaleString();
        } catch {
          return '-';
        }
      }

      async function refreshAbout() {
        const api = window.agathaSettings;
        if (!api || typeof api.getAppInfo !== 'function') return;
        const info = await api.getAppInfo();
        $('about-version').textContent = info?.appVersion || '-';

        const t = info?.buildTimeIso || (info?.buildTimeMs ? new Date(info.buildTimeMs).toISOString() : null);
        if (!t) {
          $('about-build-time').textContent = '-';
          return;
        }
        // show local time plus ISO for debugging
        const local = formatDateTime(t);
        $('about-build-time').textContent = local && local !== '-' ? `${local} (${t})` : String(t);
      }

      function startClock() {
        const tick = () => {
          const now = new Date();
          $('sys-clock').textContent = now.toLocaleString();
        };
        tick();
        setInterval(tick, 1000);
      }

      $('tab-cache').addEventListener('click', () => setTab('cache'));
      $('tab-system').addEventListener('click', () => setTab('system'));
      $('tab-about').addEventListener('click', () => setTab('about'));
      $('refreshCache').addEventListener('click', refresh);
      $('clearOfflineCache').addEventListener('click', clearOfflineCache);
      $('openCacheFolder').addEventListener('click', openCacheFolder);

      startClock();
      refresh();
      refreshSystem();
      refreshAbout();
    </script>
  </body>
</html>
